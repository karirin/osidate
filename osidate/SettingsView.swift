//
//  SettingsView.swift
//  osidate
//
//  Modern redesigned version with user nickname feature
//

import SwiftUI
import Foundation
import SwiftyCrop

struct SettingsView: View {
    @ObservedObject var viewModel: RomanceAppViewModel
    @Environment(\.dismiss) private var dismiss
    @State private var showingDeleteAlert = false
    @State private var showingResetIntimacyAlert = false
    @State private var showingSignOutAlert = false
    @State private var showingResetUserDefaultsAlert = false
    @State private var isDataSyncing = false
    @FocusState private var isInputFocused: Bool
    
    // Image picker and cropping states
    @StateObject private var imageManager = ImageStorageManager()
    @State private var showingImagePicker = false
    @State private var selectedImage: UIImage?
    @State private var selectedImageForCropping: UIImage?
    @State private var croppingItem: CroppingItem?
    @State private var characterIcon: UIImage?
    @State private var showingAlert = false
    @State private var alertMessage = ""
    @State private var iconScale: CGFloat = 1.0
    
    private struct CroppingItem: Identifiable {
        let id = UUID()
        let image: UIImage
    }
    
    var body: some View {
        NavigationView {
            ScrollView {
                VStack(spacing: 10) {
                    // Header with character preview
                    characterHeaderView
                    
                    // Main settings sections
                    VStack(spacing: 16) {
                        characterSettingsSection
                        appearanceSettingsSection
                        userNicknameSettingsSection  // üåü Êñ∞Ë¶èËøΩÂä†
                        anniversarySettingsSection
                    }
                    .padding(.horizontal, 20)
                    .padding(.bottom, 32)
                }
            }
            .scrollDismissesKeyboard(.immediately)
            .contentShape(Rectangle())
            .onTapGesture {
                isInputFocused = false
            }
            .background(Color(.systemGroupedBackground))
            .setupAlerts()
            .sheet(isPresented: $viewModel.showingBackgroundSelector) {
                BackgroundSelectorView(viewModel: viewModel)
            }
            .sheet(isPresented: $showingImagePicker) {
                ImagePickerView { pickedImage in
                    self.selectedImageForCropping = pickedImage
                }
            }
            .onChange(of: selectedImageForCropping) { img in
                guard let img else { return }
                guard croppingItem == nil else { return }
                croppingItem = CroppingItem(image: img)
            }
            .fullScreenCover(item: $croppingItem) { item in
                NavigationView {
                    SwiftyCropView(
                        imageToCrop: item.image,
                        maskShape: .circle,
                        configuration: cropConfig
                    ) { cropped in
                        if let cropped {
                            withAnimation(.spring(response: 0.5, dampingFraction: 0.7)) {
                                selectedImage = cropped
                                characterIcon = cropped
                            }
                            uploadImage()
                        }
                        croppingItem = nil
                    }
                    .drawingGroup()
                }
                .navigationBarHidden(true)
            }
            .alert("ÈÄöÁü•", isPresented: $showingAlert) {
                Button("OK", role: .cancel) { }
            } message: {
                Text(alertMessage)
            }
            .onAppear {
                loadCurrentIcon()
            }
        }
    }
    
    // MARK: - Header
    private var characterHeaderView: some View {
        VStack(spacing: 16) {
            // Character icon with glow effect - clickable for editing
            Button(action: {
                generateHapticFeedback()
                withAnimation(.spring(response: 0.3, dampingFraction: 0.6)) {
                    iconScale = 0.95
                }
                DispatchQueue.main.asyncAfter(deadline: .now() + 0.1) {
                    withAnimation(.spring(response: 0.3, dampingFraction: 0.6)) {
                        iconScale = 1.0
                    }
                }
                showingImagePicker = true
            }) {
                VStack{
                    ZStack {
                        Circle()
                            .fill(intimacyColor.opacity(0.2))
                            .frame(width: 120, height: 120)
                            .blur(radius: 8)
                        
                        if let icon = characterIcon {
                            Image(uiImage: icon)
                                .resizable()
                                .aspectRatio(contentMode: .fill)
                                .frame(width: 100, height: 100)
                                .clipShape(Circle())
                                .overlay(
                                    Circle()
                                        .stroke(intimacyColor, lineWidth: 3)
                                )
                                .shadow(color: intimacyColor.opacity(0.3), radius: 8, x: 0, y: 4)
                        } else {
                            ZStack {
                                // üåü „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇíÁÑ°Âäπ„Å´„Åó„Å¶CharacterIconView„Çí‰ΩøÁî®
                                CharacterIconView(character: viewModel.character, size: 100, enableFloating: false)
                                    .clipShape(Circle())
                                    .overlay(
                                        Circle()
                                            .stroke(intimacyColor, lineWidth: 3)
                                    )
                                    .shadow(color: intimacyColor.opacity(0.3), radius: 8, x: 0, y: 4)
                                
                                // Edit overlay
                                Circle()
                                    .fill(.black.opacity(0.3))
                                    .frame(width: 100, height: 100)
                                    .overlay(
                                        VStack(spacing: 4) {
                                            Image(systemName: "camera.fill")
                                                .font(.title2)
                                                .foregroundColor(.white)
                                            Text("Á∑®ÈõÜ")
                                                .font(.caption)
                                                .foregroundColor(.white)
                                        }
                                    )
                            }
                        }
                        Circle()
                            .fill(intimacyColor)
                            .frame(width: 30, height: 30)
                            .overlay(
                                Image(systemName: "pencil")
                                    .font(.system(size: 15))
                                    .foregroundColor(.white)
                            )
                            .offset(x: 40, y: 40)
                        // Upload overlay
                        if imageManager.isUploading {
                            Circle()
                                .fill(.ultraThinMaterial)
                                .frame(width: 100, height: 100)
                                .overlay(
                                    VStack(spacing: 8) {
                                        ProgressView()
                                            .progressViewStyle(CircularProgressViewStyle(tint: intimacyColor))
                                            .scaleEffect(1.2)
                                        Text("\(Int(imageManager.uploadProgress * 100))%")
                                            .font(.caption)
                                            .foregroundColor(intimacyColor)
                                            .fontWeight(.medium)
                                    }
                                )
                        }
                    }
                    Text("„Çø„ÉÉ„Éó„ÅßÊé®„Åó„ÅÆÁîªÂÉè„ÇíÂ§âÊõ¥„Åß„Åç„Åæ„Åô")
                        .font(.caption)
                        .foregroundColor(.gray)
                        .padding(.top, 8)
                }
            }
            .scaleEffect(iconScale)
            .disabled(imageManager.isUploading)
        }
        .padding(.top, 20)
        .padding(.bottom, 8)
    }
    
    private var hasCustomBackground: Bool {
        return viewModel.character.backgroundURL != nil && !viewModel.character.backgroundURL!.isEmpty
    }
    
    private var appearanceSettingsSection: some View {
        ModernSectionView(title: "Â§ñË¶≥Ë®≠ÂÆö", icon: "paintbrush.pointed") {
            VStack(spacing: 16) {
                // Character icon editor
                ModernSettingRow(
                    icon: "person.crop.circle.badge.plus",
                    title: "„Ç¢„Ç§„Ç≥„É≥Ë®≠ÂÆö",
                    subtitle: characterIcon != nil ? "„Ç´„Çπ„Çø„É†„Ç¢„Ç§„Ç≥„É≥„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åô" : "„Éá„Éï„Ç©„É´„Éà„Ç¢„Ç§„Ç≥„É≥„Çí‰ΩøÁî®‰∏≠"
                ) {
                    Button {
                        generateHapticFeedback()
                        showingImagePicker = true
                    } label: {
                        HStack(spacing: 8) {
                            if imageManager.isUploading {
                                ProgressView()
                                    .scaleEffect(0.8)
                                Text("„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ‰∏≠...")
                                    .font(.caption)
                                    .foregroundColor(.secondary)
                            } else {
                                Image(systemName: "camera.fill")
                                    .foregroundColor(.blue)
                                Text("Á∑®ÈõÜ")
                                    .foregroundColor(.blue)
                                    .fontWeight(.medium)
                            }
                        }
                        .padding(.horizontal, 12)
                        .padding(.vertical, 6)
                        .background(.blue.opacity(0.1))
                        .cornerRadius(8)
                    }
                    .disabled(imageManager.isUploading)
                }
                
                Divider()
                
                // Background editor
                ModernSettingRow(
                    icon: "photo.on.rectangle.angled",
                    title: "ËÉåÊôØË®≠ÂÆö",
                    subtitle: hasCustomBackground ? "„Ç´„Çπ„Çø„É†ËÉåÊôØ„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åô" : "„Éó„É™„Çª„ÉÉ„ÉàËÉåÊôØ„Çí‰ΩøÁî®‰∏≠"
                ) {
                    Button {
                        generateHapticFeedback()
                        viewModel.showingBackgroundSelector = true
                    } label: {
                        HStack(spacing: 8) {
                            Image(systemName: "paintbrush.pointed.fill")
                                .foregroundColor(.purple)
                            Text("Á∑®ÈõÜ")
                                .foregroundColor(.purple)
                                .fontWeight(.medium)
                            Image(systemName: "chevron.right")
                                .font(.caption)
                                .foregroundColor(.secondary)
                        }
                        .padding(.horizontal, 12)
                        .padding(.vertical, 6)
                        .background(.purple.opacity(0.1))
                        .cornerRadius(8)
                    }
                }
                
                // Show current background preview if custom background is set
                if hasCustomBackground {
                    Divider()
                    
                    HStack {
                        Image(systemName: "photo")
                            .foregroundColor(.secondary)
                            .frame(width: 24)
                        
                        VStack(alignment: .leading, spacing: 2) {
                            Text("ÁèæÂú®„ÅÆËÉåÊôØ")
                                .font(.subheadline)
                                .foregroundColor(.primary)
                            Text("„Ç´„Çπ„Çø„É†ÁîªÂÉè„Çí‰ΩøÁî®")
                                .font(.caption)
                                .foregroundColor(.secondary)
                        }
                        
                        Spacer()
                        
                        // Small background preview
                        Group {
                            if let backgroundURL = viewModel.character.backgroundURL,
                               let url = URL(string: backgroundURL) {
                                AsyncImage(url: url) { image in
                                    image
                                        .resizable()
                                        .aspectRatio(contentMode: .fill)
                                } placeholder: {
                                    Rectangle()
                                        .fill(Color.gray.opacity(0.3))
                                        .overlay(
                                            ProgressView()
                                                .scaleEffect(0.6)
                                        )
                                }
                            } else {
                                Image(viewModel.character.backgroundName)
                                    .resizable()
                                    .aspectRatio(contentMode: .fill)
                            }
                        }
                        .frame(width: 60, height: 40)
                        .clipShape(RoundedRectangle(cornerRadius: 8))
                        .overlay(
                            RoundedRectangle(cornerRadius: 8)
                                .stroke(Color(.systemGray4), lineWidth: 1)
                        )
                    }
                }
            }
        }
    }
    
    // MARK: - Character Settings
    private var characterSettingsSection: some View {
        ModernSectionView(title: "„Ç≠„É£„É©„ÇØ„Çø„ÉºË®≠ÂÆö", icon: "person.circle") {
            VStack(spacing: 16) {
                // Name field
                ModernSettingRow(
                    icon: "textformat",
                    title: "ÂêçÂâç",
                    subtitle: "„Ç≠„É£„É©„ÇØ„Çø„Éº„ÅÆÂëº„Å≥Âêç"
                ) {
                    TextField("ÂêçÂâç„ÇíÂÖ•Âäõ", text: $viewModel.character.name)
                        .textFieldStyle(ModernTextFieldStyle())
                        .focused($isInputFocused)
                        .onChange(of: viewModel.character.name) { _ in
                            viewModel.updateCharacterSettings()
                        }
                }
                
                Divider()
                
                // Personality editor
                VStack(alignment: .leading, spacing: 12) {
                    HStack {
                        Image(systemName: "heart.text.square")
                            .foregroundColor(.pink)
                            .frame(width: 24)
                        VStack(alignment: .leading, spacing: 2) {
                            Text("ÊÄßÊ†º")
                                .font(.headline)
                                .foregroundColor(.primary)
                            Text("„Ç≠„É£„É©„ÇØ„Çø„Éº„ÅÆÂÄãÊÄß„ÇíË®≠ÂÆö")
                                .font(.caption)
                                .foregroundColor(.secondary)
                        }
                    }
                    
                    TextEditor(text: $viewModel.character.personality)
                        .frame(minHeight: 80)
                        .padding(12)
                        .background(Color(.systemBackground))
                        .cornerRadius(12)
                        .overlay(
                            RoundedRectangle(cornerRadius: 12)
                                .stroke(Color(.systemGray4), lineWidth: 1)
                        )
                        .focused($isInputFocused)
                        .onChange(of: viewModel.character.personality) { _ in
                            viewModel.updateCharacterSettings()
                        }
                }
                
                Divider()
                
                // Speaking style editor
                VStack(alignment: .leading, spacing: 12) {
                    HStack {
                        Image(systemName: "bubble.left.and.bubble.right")
                            .foregroundColor(.blue)
                            .frame(width: 24)
                        VStack(alignment: .leading, spacing: 2) {
                            Text("Ë©±„ÅóÊñπ")
                                .font(.headline)
                                .foregroundColor(.primary)
                            Text("‰ºöË©±„ÅÆ„Çπ„Çø„Ç§„É´„ÇíË®≠ÂÆö")
                                .font(.caption)
                                .foregroundColor(.secondary)
                        }
                    }
                    
                    TextEditor(text: $viewModel.character.speakingStyle)
                        .frame(minHeight: 80)
                        .padding(12)
                        .background(Color(.systemBackground))
                        .cornerRadius(12)
                        .overlay(
                            RoundedRectangle(cornerRadius: 12)
                                .stroke(Color(.systemGray4), lineWidth: 1)
                        )
                        .focused($isInputFocused)
                        .onChange(of: viewModel.character.speakingStyle) { _ in
                            viewModel.updateCharacterSettings()
                        }
                }
            }
        }
    }

    // MARK: - üåü User Nickname Settings Section
    private var userNicknameSettingsSection: some View {
        ModernSectionView(title: "„ÅÇ„Å™„Åü„ÅÆÂëº„Å≥ÂêçË®≠ÂÆö", icon: "person.badge.plus") {
            VStack(spacing: 16) {
                // Nickname input field - Â∏∏„Å´Ë°®Á§∫
                ModernSettingRow(
                    icon: "textformat.alt",
                    title: "Âëº„Å≥Âêç"
                ) {
                    TextField("Âëº„Å≥Âêç„ÇíÂÖ•Âäõ", text: $viewModel.character.userNickname)
                        .textFieldStyle(ModernTextFieldStyle())
                        .focused($isInputFocused)
                        .onChange(of: viewModel.character.userNickname) { newValue in
                            // 20ÊñáÂ≠óÂà∂Èôê
                            if newValue.count > 20 {
                                viewModel.character.userNickname = String(newValue.prefix(20))
                            }
                            
                            // Âëº„Å≥Âêç„ÅåÂÖ•Âäõ„Åï„Çå„ÅüÂ†¥Âêà„ÅØËá™ÂãïÁöÑ„Å´useNickname„Çítrue„Å´Ë®≠ÂÆö
                            if !newValue.isEmpty && !viewModel.character.useNickname {
                                viewModel.character.useNickname = true
                                sendNicknameChangeMessage(enabled: true)
                            }
                            // Âëº„Å≥Âêç„ÅåÁ©∫„Å´„Å™„Å£„ÅüÂ†¥Âêà„ÅØËá™ÂãïÁöÑ„Å´useNickname„Çífalse„Å´Ë®≠ÂÆö
                            else if newValue.isEmpty && viewModel.character.useNickname {
                                viewModel.character.useNickname = false
                                sendNicknameChangeMessage(enabled: false)
                            }
                            
                            viewModel.updateCharacterSettings()
                        }
                        .onSubmit {
                            if !viewModel.character.userNickname.isEmpty {
                                sendNicknameSetMessage()
                            }
                        }
                }
            }
        }
    }
    
    // MARK: - Anniversary Settings
    private var anniversarySettingsSection: some View {
        ModernSectionView(title: "Ë®òÂøµÊó•Ë®≠ÂÆö", icon: "calendar.badge.plus") {
            VStack(spacing: 16) {
                // Birthday setting
                birthdaySettingRow
                
                if viewModel.character.birthday != nil {
                    Divider()
                    
                    Button {
                        viewModel.character.birthday = nil
                        viewModel.updateCharacterSettings()
                    } label: {
                        HStack {
                            Image(systemName: "trash")
                                .foregroundColor(.red)
                            Text("Ë™ïÁîüÊó•„ÇíÂâäÈô§")
                                .foregroundColor(.red)
                            Spacer()
                        }
                    }
                }
                
                Divider()
                
                // Anniversary setting
                anniversarySettingRow
                
                if viewModel.character.anniversaryDate != nil {
                    Divider()
                    
                    Button {
                        viewModel.character.anniversaryDate = nil
                        viewModel.updateCharacterSettings()
                    } label: {
                        HStack {
                            Image(systemName: "trash")
                                .foregroundColor(.red)
                            Text("Ë®òÂøµÊó•„ÇíÂâäÈô§")
                                .foregroundColor(.red)
                            Spacer()
                        }
                    }
                }
            }
        }
    }
    
    private var birthdaySettingRow: some View {
        ModernSettingRow(
            icon: "gift",
            title: "Ë™ïÁîüÊó•",
            subtitle: viewModel.character.birthday != nil ? dateFormatter.string(from: viewModel.character.birthday!) : "Êú™Ë®≠ÂÆö"
        ) {
            if viewModel.character.birthday != nil {
                DatePicker("", selection: Binding(
                    get: { viewModel.character.birthday ?? Date() },
                    set: { newValue in
                        viewModel.character.birthday = newValue
                        viewModel.updateCharacterSettings()
                    }
                ), displayedComponents: [.date])
                .labelsHidden()
                .datePickerStyle(.compact)
            } else {
                Button("Ë®≠ÂÆö") {
                    viewModel.character.birthday = Date()
                    viewModel.updateCharacterSettings()
                }
                .buttonStyle(ModernButtonStyle(color: .blue))
            }
        }
    }
    
    private var anniversarySettingRow: some View {
        ModernSettingRow(
            icon: "heart.circle",
            title: "Ë®òÂøµÊó•",
            subtitle: viewModel.character.anniversaryDate != nil ? dateFormatter.string(from: viewModel.character.anniversaryDate!) : "Êú™Ë®≠ÂÆö"
        ) {
            if viewModel.character.anniversaryDate != nil {
                DatePicker("", selection: Binding(
                    get: { viewModel.character.anniversaryDate ?? Date() },
                    set: { newValue in
                        viewModel.character.anniversaryDate = newValue
                        viewModel.updateCharacterSettings()
                    }
                ), displayedComponents: [.date])
                .labelsHidden()
                .datePickerStyle(.compact)
            } else {
                Button("Ë®≠ÂÆö") {
                    viewModel.character.anniversaryDate = Date()
                    viewModel.updateCharacterSettings()
                }
                .buttonStyle(ModernButtonStyle(color: .pink))
            }
        }
    }
    
    // MARK: - Helper Properties
    private var intimacyColor: Color {
        return viewModel.character.intimacyStage.color
    }
    
    private var dateFormatter: DateFormatter {
        let formatter = DateFormatter()
        formatter.dateStyle = .medium
        formatter.timeStyle = .none
        formatter.locale = Locale(identifier: "ja_JP")
        return formatter
    }
    
    // SwiftyCrop configuration
    private var cropConfig: SwiftyCropConfiguration {
        var cfg = SwiftyCropConfiguration(
            texts: .init(
                cancelButton: "„Ç≠„É£„É≥„Çª„É´",
                interactionInstructions: "",
                saveButton: "ÈÅ©Áî®"
            )
        )
        return cfg
    }

    private func getNicknameSuggestions() -> [String] {
        let intimacyLevel = viewModel.character.intimacyLevel
        
        switch intimacyLevel {
        case 0...100:
            return ["„Åï„Çì", "„Åè„Çì", "„ÅäÂèãÈÅî", "„Éë„Éº„Éà„Éä„Éº", "Áõ∏Ê£í", "„Éê„Éá„Ç£"]
        case 101...300:
            return ["„Å°„ÇÉ„Çì", "Âêõ", "„ÅäÁñ≤„ÇåÊßò", "Â§ßÂàá„Å™‰∫∫", "ÁâπÂà•„Å™‰∫∫", "Ë¶™Âèã"]
        case 301...700:
            return ["ÊÑõ„Åó„ÅÑ‰∫∫", "„ÉÄ„Éº„É™„É≥", "„Éè„Éã„Éº", "Â§ßÂ•Ω„Åç„Å™‰∫∫", "ÊÅã‰∫∫", "„Çπ„Ç§„Éº„Éà"]
        case 701...1300:
            return ["ÊúÄÊÑõ„ÅÆ‰∫∫", "ÈÅãÂëΩ„ÅÆ‰∫∫", "ÊÑõ„Åô„Çã‰∫∫", "„Éû„Ç§„É©„Éñ", "ÂÆùÁâ©", "Â§©‰Ωø"]
        case 1301...2000:
            return ["È≠Ç„ÅÆ‰º¥‰æ∂", "Ê∞∏ÈÅ†„ÅÆÊÑõ", "ÂëΩ„ÅÆ‰∫∫", "Â•áË∑°", "ÂÖâ", "Â∏åÊúõ"]
        default:
            return ["ÁÑ°Èôê„ÅÆÊÑõ", "Ê∞∏ÈÅ†", "ÂîØ‰∏ÄÁÑ°‰∫å", "ÂÖ®„Å¶", "‰∏ñÁïå", "ÂÆáÂÆô"]
        }
    }

    private func getIntimacyBasedPreview() -> String {
        let nickname = viewModel.character.userDisplayName
        let intimacyLevel = viewModel.character.intimacyLevel
        
        switch intimacyLevel {
        case 0...100:
            return "\(nickname)„ÄÅ‰ªäÂ∫¶‰∏ÄÁ∑í„Å´„ÅäÂá∫„Åã„Åë„Åó„Åæ„Åõ„Çì„ÅãÔºü"
        case 101...300:
            return "\(nickname)„ÅÆ„Åì„Å®„Çí„ÇÇ„Å£„Å®Áü•„Çä„Åü„ÅÑ„Åß„Åô"
        case 301...700:
            return "\(nickname)„ÄÅÊÑõ„Åó„Å¶„Çã„Çàüíï"
        case 701...1300:
            return "\(nickname)„Åå„ÅÑ„Å¶„Åè„Çå„Å¶Êú¨ÂΩì„Å´Âπ∏„Åõ„Åß„Åô"
        case 1301...2000:
            return "\(nickname)„ÄÅ„ÅÇ„Å™„Åü„ÅØÁßÅ„ÅÆÂÖ®„Å¶„Åß„Åô"
        default:
            return "\(nickname)„ÄÅÁßÅ„Åü„Å°„ÅÆÊÑõ„ÅØÊ∞∏ÈÅ†„Åß„Åô„Å≠‚ôæÔ∏è"
        }
    }

    private func suggestDefaultNickname() {
        let suggestions = getNicknameSuggestions()
        if let defaultSuggestion = suggestions.first {
            viewModel.character.userNickname = defaultSuggestion
        }
    }

    private func sendNicknameChangeMessage(enabled: Bool) {
        let message: String
        
        if enabled {
            let nickname = viewModel.character.userNickname.isEmpty ? "ÁâπÂà•„Å™Âëº„Å≥Âêç" : viewModel.character.userNickname
            message = "„Åì„Çå„Åã„Çâ„ÅØ\(nickname)„Å£„Å¶Âëº„Å∞„Åõ„Å¶„ÇÇ„Çâ„ÅÑ„Åæ„Åô„Å≠üíï ÁâπÂà•„Å™Âëº„Å≥Âêç„ÅßÂëº„Åπ„Çã„Å™„Çì„Å¶„ÄÅ„Å™„Çì„Å†„ÅãÂ¨â„Åó„ÅÑ„Åß„Åô‚ú®"
        } else {
            message = "ÂàÜ„Åã„Çä„Åæ„Åó„Åü„ÄÇ„Åì„Çå„Åã„Çâ„ÅØÊôÆÈÄö„Å´„Äå„ÅÇ„Å™„Åü„Äç„Å£„Å¶Âëº„Å≥„Åæ„Åô„Å≠„ÄÇ„Åß„ÇÇ„ÄÅÂøÉ„ÅÆ‰∏≠„Åß„ÅØ„ÅÑ„Å§„Åß„ÇÇÁâπÂà•„Å™Â≠òÂú®„Åß„Åô„Çàüíï"
        }
        
        // ViewModel„Å´„É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°„Çí‰æùÈ†º
        DispatchQueue.main.asyncAfter(deadline: .now() + 0.5) {
            viewModel.sendSystemMessage(message)
        }
    }

    private func sendNicknameSetMessage() {
        let nickname = viewModel.character.userNickname
        guard !nickname.isEmpty else { return }
        
        let message = "\(nickname)...Á¥†Êïµ„Å™Èüø„Åç„Åß„Åô„Å≠üíï „Åì„Çå„Åã„Çâ\(nickname)„Å£„Å¶Âëº„Å∞„Åõ„Å¶„ÅÑ„Åü„Å†„Åç„Åæ„Åô„ÄÇÁâπÂà•„Å™Âëº„Å≥Âêç„Çí„Å§„Åë„Å¶„ÇÇ„Çâ„Åà„Å¶„ÄÅ„Å®„Å¶„ÇÇÂ¨â„Åó„ÅÑ„Åß„Åô‚ú®"
        
        DispatchQueue.main.asyncAfter(deadline: .now() + 0.5) {
            viewModel.sendSystemMessage(message)
        }
    }
    
    // MARK: - Image Management Functions
    private func loadCurrentIcon() {
        if let iconURL = viewModel.character.iconURL, !iconURL.isEmpty {
            imageManager.loadImage(from: iconURL) { result in
                switch result {
                case .success(let image):
                    withAnimation(.spring(response: 0.5, dampingFraction: 0.7)) {
                        characterIcon = image
                    }
                case .failure(let error):
                    print("„Ç¢„Ç§„Ç≥„É≥„ÅÆË™≠„ÅøËæº„Åø„Ç®„É©„Éº: \(error.localizedDescription)")
                }
            }
        }
    }
    
    private func uploadImage() {
        guard let image = selectedImage,
              let userId = viewModel.currentUserID else {
            alertMessage = "ÁîªÂÉè„ÅÆ„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü"
            showingAlert = true
            return
        }
        
        let imagePath = "character_icons/\(userId)_\(viewModel.character.id)_\(Date().timeIntervalSince1970).jpg"
        
        imageManager.uploadImage(image, path: imagePath) { [weak viewModel] result in
            DispatchQueue.main.async {
                switch result {
                case .success(let downloadURL):
                    if let oldIconURL = viewModel?.character.iconURL,
                       !oldIconURL.isEmpty,
                       let oldPath = extractPathFromURL(oldIconURL) {
                        imageManager.deleteImage(at: oldPath) { _ in }
                    }
                    
                    viewModel?.character.iconURL = downloadURL
                    viewModel?.updateCharacterSettings()
                    
                    characterIcon = image
                    selectedImage = nil
                    
                    alertMessage = "„Ç¢„Ç§„Ç≥„É≥„ÅåÊ≠£Â∏∏„Å´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åï„Çå„Åæ„Åó„Åü"
                    showingAlert = true
                    
                case .failure(let error):
                    alertMessage = "„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Ç®„É©„Éº: \(error.localizedDescription)"
                    showingAlert = true
                }
            }
        }
    }
    
    private func extractPathFromURL(_ url: String) -> String? {
        guard let urlComponents = URLComponents(string: url),
              let path = urlComponents.path.components(separatedBy: "/o/").last?.components(separatedBy: "?").first else {
            return nil
        }
        return path.removingPercentEncoding
    }
    
    private func generateHapticFeedback() {
        let impactFeedback = UIImpactFeedbackGenerator(style: .light)
        impactFeedback.impactOccurred()
    }
}

// MARK: - Supporting Views

struct SuggestionButtonStyle: ButtonStyle {
    let isSelected: Bool
    
    func makeBody(configuration: Configuration) -> some View {
        configuration.label
            .font(.caption)
            .fontWeight(.medium)
            .padding(.horizontal, 12)
            .padding(.vertical, 6)
            .background(isSelected ? Color.blue.opacity(0.2) : Color.gray.opacity(0.1))
            .foregroundColor(isSelected ? .blue : .primary)
            .cornerRadius(12)
            .overlay(
                RoundedRectangle(cornerRadius: 12)
                    .stroke(isSelected ? Color.blue.opacity(0.5) : Color.clear, lineWidth: 1)
            )
            .scaleEffect(configuration.isPressed ? 0.95 : 1.0)
            .animation(.easeInOut(duration: 0.1), value: configuration.isPressed)
    }
}

struct PreviewMessageBubble: View {
    let text: String
    let isFromAI: Bool
    
    var body: some View {
        HStack {
            if !isFromAI {
                Spacer()
            }
            
            Text(text)
                .font(.subheadline)
                .padding(.horizontal, 12)
                .padding(.vertical, 8)
                .background(isFromAI ? Color.gray.opacity(0.1) : Color.blue.opacity(0.1))
                .foregroundColor(.primary)
                .cornerRadius(12)
                .frame(maxWidth: UIScreen.main.bounds.width * 0.7, alignment: isFromAI ? .leading : .trailing)
            
            if isFromAI {
                Spacer()
            }
        }
    }
}

// MARK: - Modern UI Components

struct ModernSectionView<Content: View>: View {
    let title: String
    let icon: String
    let content: Content
    
    init(title: String, icon: String, @ViewBuilder content: () -> Content) {
        self.title = title
        self.icon = icon
        self.content = content()
    }
    
    var body: some View {
        VStack(alignment: .leading, spacing: 16) {
            HStack(spacing: 8) {
                Image(systemName: icon)
                    .foregroundColor(.accentColor)
                    .font(.title3)
                Text(title)
                    .font(.title3)
                    .fontWeight(.semibold)
                    .foregroundColor(.primary)
                Spacer()
            }
            
            content
        }
        .padding(20)
        .background(Color(.systemBackground))
        .cornerRadius(16)
        .shadow(color: .black.opacity(0.05), radius: 8, x: 0, y: 2)
    }
}

struct ModernSettingRow<Content: View>: View {
    let icon: String
    let title: String
    let subtitle: String?
    let content: Content
    
    init(icon: String, title: String, subtitle: String? = nil, @ViewBuilder content: () -> Content) {
        self.icon = icon
        self.title = title
        self.subtitle = subtitle
        self.content = content()
    }
    
    var body: some View {
        HStack(spacing: 16) {
            Image(systemName: icon)
                .foregroundColor(.accentColor)
                .frame(width: 24)
            
            VStack(alignment: .leading, spacing: 2) {
                Text(title)
                    .font(.headline)
                    .foregroundColor(.primary)
                if let subtitle = subtitle {
                    Text(subtitle)
                        .font(.caption)
                        .foregroundColor(.secondary)
                }
            }
            
            Spacer()
            
            content
        }
    }
}

struct ModernButtonStyle: ButtonStyle {
    let color: Color
    
    func makeBody(configuration: Configuration) -> some View {
        configuration.label
            .padding(.horizontal, 16)
            .padding(.vertical, 8)
            .background(color.opacity(0.1))
            .foregroundColor(color)
            .cornerRadius(8)
            .scaleEffect(configuration.isPressed ? 0.95 : 1.0)
            .animation(.easeInOut(duration: 0.1), value: configuration.isPressed)
    }
}

// MARK: - Alert Extension
extension View {
    func setupAlerts() -> some View {
        self
    }
}

#Preview {
    SettingsView(viewModel: RomanceAppViewModel())
}
